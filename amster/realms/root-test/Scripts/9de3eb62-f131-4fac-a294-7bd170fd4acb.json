{
  "metadata" : {
    "realm" : "/test",
    "amsterVersion" : "14.0.0",
    "entityType" : "Scripts",
    "entityId" : "9de3eb62-f131-4fac-a294-7bd170fd4acb",
    "pathParams" : { }
  },
  "data" : {
    "_id" : "9de3eb62-f131-4fac-a294-7bd170fd4acb",
    "name" : "Scripted Policy Condition",
    "description" : "Default global script for Scripted Policy Conditions",
    "script" : "LyoqCiAqIFRoaXMgaXMgYSBQb2xpY3kgQ29uZGl0aW9uIGV4YW1wbGUgc2NyaXB0LiBJdCBkZW1vbnN0cmF0ZXMgaG93IHRvIGFjY2VzcyBhIHVzZXIncyBpbmZvcm1hdGlvbiwKICogdXNlIHRoYXQgaW5mb3JtYXRpb24gaW4gZXh0ZXJuYWwgSFRUUCBjYWxscyBhbmQgbWFrZSBhIHBvbGljeSBkZWNpc2lvbiBiYXNlZCBvbiB0aGUgb3V0Y29tZS4KICovCgp2YXIgdXNlckFkZHJlc3MsIHVzZXJJUCwgcmVzb3VyY2VIb3N0OwoKaWYgKHZhbGlkYXRlQW5kSW5pdGlhbGl6ZVBhcmFtZXRlcnMoKSkgewoKICAgIHZhciBjb3VudHJ5RnJvbVVzZXJBZGRyZXNzID0gZ2V0Q291bnRyeUZyb21Vc2VyQWRkcmVzcygpOwogICAgbG9nZ2VyLm1lc3NhZ2UoIkNvdW50cnkgcmV0cmlldmVkIGZyb20gdXNlcidzIGFkZHJlc3M6ICIgKyBjb3VudHJ5RnJvbVVzZXJBZGRyZXNzKTsKICAgIHZhciBjb3VudHJ5RnJvbVVzZXJJUCA9IGdldENvdW50cnlGcm9tVXNlcklQKCk7CiAgICBsb2dnZXIubWVzc2FnZSgiQ291bnRyeSByZXRyaWV2ZWQgZnJvbSB1c2VyJ3MgSVA6ICIgKyBjb3VudHJ5RnJvbVVzZXJJUCk7CiAgICB2YXIgY291bnRyeUZyb21SZXNvdXJjZVVSSSA9IGdldENvdW50cnlGcm9tUmVzb3VyY2VVUkkoKTsKICAgIGxvZ2dlci5tZXNzYWdlKCJDb3VudHJ5IHJldHJpZXZlZCBmcm9tIHJlc291cmNlIFVSSTogIiArIGNvdW50cnlGcm9tUmVzb3VyY2VVUkkpOwoKICAgIGlmIChjb3VudHJ5RnJvbVVzZXJBZGRyZXNzID09PSBjb3VudHJ5RnJvbVVzZXJJUCAmJiBjb3VudHJ5RnJvbVVzZXJBZGRyZXNzID09PSBjb3VudHJ5RnJvbVJlc291cmNlVVJJKSB7CiAgICAgICAgbG9nZ2VyLm1lc3NhZ2UoIkF1dGhvcml6YXRpb24gU3VjY2VlZGVkIik7CiAgICAgICAgcmVzcG9uc2VBdHRyaWJ1dGVzLnB1dCgiY291bnRyeU9mT3JpZ2luIiwgW2NvdW50cnlGcm9tVXNlckFkZHJlc3NdKTsKICAgICAgICBhdXRob3JpemVkID0gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgICAgbG9nZ2VyLm1lc3NhZ2UoIkF1dGhvcml6YXRpb24gRmFpbGVkIik7CiAgICAgICAgYXV0aG9yaXplZCA9IGZhbHNlOwogICAgfQoKfSBlbHNlIHsKICAgIGxvZ2dlci5tZXNzYWdlKCJSZXF1aXJlZCBwYXJhbWV0ZXJzIG5vdCBmb3VuZC4gQXV0aG9yaXphdGlvbiBGYWlsZWQuIik7CiAgICBhdXRob3JpemVkID0gZmFsc2U7Cn0KCi8qKgogKiBVc2UgdGhlIHVzZXIncyBhZGRyZXNzIHRvIGxvb2t1cCB0aGVpciBjb3VudHJ5IG9mIHJlc2lkZW5jZS4KICoKICogQHJldHVybnMgeyp9IFRoZSB1c2VyJ3MgY291bnRyeSBvZiByZXNpZGVuY2UuCiAqLwpmdW5jdGlvbiBnZXRDb3VudHJ5RnJvbVVzZXJBZGRyZXNzKCkgewogICAgdmFyIHJlc3BvbnNlID0gaHR0cENsaWVudC5nZXQoImh0dHA6Ly9tYXBzLmdvb2dsZWFwaXMuY29tL21hcHMvYXBpL2dlb2NvZGUvanNvbj9hZGRyZXNzPSIgKwogICAgICAgIGVuY29kZVVSSUNvbXBvbmVudCh1c2VyQWRkcmVzcyksIHsKICAgICAgICBjb29raWVzOiBbXSwKICAgICAgICBoZWFkZXJzOiBbXQogICAgfSk7CiAgICBsb2dSZXNwb25zZShyZXNwb25zZSk7CgogICAgdmFyIGdlb2NvZGUgPSBKU09OLnBhcnNlKHJlc3BvbnNlLmdldEVudGl0eSgpKTsKICAgIHZhciBpOwogICAgZm9yIChpID0gMDsgaSA8IGdlb2NvZGUucmVzdWx0cy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciByZXN1bHQgPSBnZW9jb2RlLnJlc3VsdHNbaV07CiAgICAgICAgdmFyIGo7CiAgICAgICAgZm9yIChqID0gMDsgaiA8IHJlc3VsdC5hZGRyZXNzX2NvbXBvbmVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKHJlc3VsdC5hZGRyZXNzX2NvbXBvbmVudHNbaV0udHlwZXNbMF0gPT0gImNvdW50cnkiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0LmFkZHJlc3NfY29tcG9uZW50c1tpXS5sb25nX25hbWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCi8qKgogKiBVc2UgdGhlIHVzZXIncyBJUCB0byBsb29rdXAgdGhlIGNvdW50cnkgZnJvbSB3aGljaCB0aGUgcmVxdWVzdCBvcmlnaW5hdGVkLgogKgogKiBAcmV0dXJucyB7Kn0gVGhlIGNvdW50cnkgZnJvbSB3aGljaCB0aGUgcmVxdWVzdCBvcmlnaW5hdGVkLgogKi8KZnVuY3Rpb24gZ2V0Q291bnRyeUZyb21Vc2VySVAoKSB7CiAgICB2YXIgcmVzcG9uc2UgPSBodHRwQ2xpZW50LmdldCgiaHR0cDovL2lwLWFwaS5jb20vanNvbi8iICsgdXNlcklQLCB7CiAgICAgICAgY29va2llczogW10sCiAgICAgICAgaGVhZGVyczogW10KICAgIH0pOwogICAgbG9nUmVzcG9uc2UocmVzcG9uc2UpOwoKICAgIHZhciByZXN1bHQgPSBKU09OLnBhcnNlKHJlc3BvbnNlLmdldEVudGl0eSgpKTsKICAgIGlmIChyZXN1bHQpIHsKICAgICAgICByZXR1cm4gcmVzdWx0LmNvdW50cnk7CiAgICB9Cn0KCi8qKgogKiBVc2UgdGhlIHJlcXVlc3RlZCByZXNvdXJjZSdzIGhvc3QgbmFtZSB0byBsb29rdXAgdGhlIGNvdW50cnkgd2hlcmUgdGhlIHJlc291cmNlIGlzIGhvc3RlZC4KICoKICogQHJldHVybnMgeyp9IFRoZSBjb3VudHJ5IGluIHdoaWNoIHRoZSByZXNvdXJjZSBpcyBob3N0ZWQuCiAqLwpmdW5jdGlvbiBnZXRDb3VudHJ5RnJvbVJlc291cmNlVVJJKCkgewogICAgcmVzcG9uc2UgPSBodHRwQ2xpZW50LmdldCgiaHR0cDovL2lwLWFwaS5jb20vanNvbi8iICsgZW5jb2RlVVJJQ29tcG9uZW50KHJlc291cmNlSG9zdCksIHsKICAgICAgICBjb29raWVzOiBbXSwKICAgICAgICBoZWFkZXJzOiBbXQogICAgfSk7CiAgICBsb2dSZXNwb25zZShyZXNwb25zZSk7CgogICAgdmFyIHJlc3VsdCA9IEpTT04ucGFyc2UocmVzcG9uc2UuZ2V0RW50aXR5KCkpOwogICAgaWYgKHJlc3VsdCkgewogICAgICAgIHJldHVybiByZXN1bHQuY291bnRyeTsKICAgIH0KfQoKLyoqCiAqIFJldHJpZXZlIGFuZCB2YWxpZGF0ZSB0aGUgdmFyaWFibGVzIHJlcXVpcmVkIHRvIG1ha2UgdGhlIGV4dGVybmFsIEhUVFAgY2FsbHMuCiAqCiAqIEByZXR1cm5zIHtib29sZWFufSBXaWxsIGJlIHRydWUgaWYgdmFsaWRhdGlvbiB3YXMgc3VjY2Vzc2Z1bC4KICovCmZ1bmN0aW9uIHZhbGlkYXRlQW5kSW5pdGlhbGl6ZVBhcmFtZXRlcnMoKSB7CiAgICB2YXIgdXNlckFkZHJlc3NTZXQgPSBpZGVudGl0eS5nZXRBdHRyaWJ1dGUoInBvc3RhbEFkZHJlc3MiKTsKICAgIGlmICh1c2VyQWRkcmVzc1NldCA9PSBudWxsIHx8IHVzZXJBZGRyZXNzU2V0LmlzRW1wdHkoKSkgewogICAgICAgIGxvZ2dlci53YXJuaW5nKCJObyBhZGRyZXNzIHNwZWNpZmllZCBmb3IgdXNlcjogIiArIHVzZXJuYW1lKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB1c2VyQWRkcmVzcyA9IHVzZXJBZGRyZXNzU2V0Lml0ZXJhdG9yKCkubmV4dCgpOwogICAgbG9nZ2VyLm1lc3NhZ2UoIlVzZXIgYWRkcmVzczogIiArIHVzZXJBZGRyZXNzKTsKCiAgICBpZiAoIWVudmlyb25tZW50KSB7CiAgICAgICAgbG9nZ2VyLndhcm5pbmcoIk5vIGVudmlyb25tZW50IHBhcmFtZXRlcnMgc3BlY2lmaWVkIGluIHRoZSBldmFsdWF0aW9uIHJlcXVlc3QuIik7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHZhciBpcFNldCA9IGVudmlyb25tZW50LmdldCgiSVAiKTsKICAgIGlmIChpcFNldCA9PSBudWxsIHx8IGlwU2V0LmlzRW1wdHkoKSkgewogICAgICAgIGxvZ2dlci53YXJuaW5nKCJObyBJUCBzcGVjaWZpZWQgaW4gdGhlIGV2YWx1YXRpb24gcmVxdWVzdCBlbnZpcm9ubWVudCBwYXJhbWV0ZXJzLiIpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHVzZXJJUCA9IGlwU2V0Lml0ZXJhdG9yKCkubmV4dCgpOwogICAgbG9nZ2VyLm1lc3NhZ2UoIlVzZXIgSVA6ICIgKyB1c2VySVApOwoKICAgIGlmICghcmVzb3VyY2VVUkkpIHsKICAgICAgICBsb2dnZXIud2FybmluZygiTm8gcmVzb3VyY2UgVVJJIHNwZWNpZmllZC4iKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByZXNvdXJjZUhvc3QgPSByZXNvdXJjZVVSSS5tYXRjaCgvXiguKjpcL1wvKSh3d3dcLik/KFtBLVphLXowLTlcLVwuXSspKDpbMC05XSspPyguKikkLylbM107CiAgICBsb2dnZXIubWVzc2FnZSgiUmVzb3VyY2UgaG9zdDogIiArIHJlc291cmNlSG9zdCk7CgogICAgcmV0dXJuIHRydWU7Cn0KCmZ1bmN0aW9uIGxvZ1Jlc3BvbnNlKHJlc3BvbnNlKSB7CiAgICBsb2dnZXIubWVzc2FnZSgiVXNlciBSRVNUIENhbGwuIFN0YXR1czogIiArIHJlc3BvbnNlLmdldFN0YXR1c0NvZGUoKSArICIsIEJvZHk6ICIgKyByZXNwb25zZS5nZXRFbnRpdHkoKSk7Cn0=",
    "default" : true,
    "language" : "JAVASCRIPT",
    "context" : "POLICY_CONDITION",
    "createdBy" : "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org",
    "creationDate" : 1433147666269,
    "lastModifiedBy" : "id=amadmin,ou=user,dc=openam,dc=forgerock,dc=org",
    "lastModifiedDate" : 1491321536445
  }
}