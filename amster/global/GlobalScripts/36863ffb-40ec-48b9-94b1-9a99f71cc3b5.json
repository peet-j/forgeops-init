{
  "metadata" : {
    "realm" : null,
    "amsterVersion" : "14.0.0",
    "entityType" : "GlobalScripts",
    "entityId" : "36863ffb-40ec-48b9-94b1-9a99f71cc3b5",
    "pathParams" : { }
  },
  "data" : {
    "_id" : "36863ffb-40ec-48b9-94b1-9a99f71cc3b5",
    "lastModifiedDate" : "1494596692445",
    "createdBy" : "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org",
    "lastModifiedBy" : "id=amAdmin,ou=user,dc=example,dc=com",
    "name" : "OIDC Claims Script",
    "context" : "OIDC_CLAIMS",
    "description" : "Default global script for OIDC claims",
    "language" : "GROOVY",
    "creationDate" : "1433147666269",
    "script" : "LyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBGb3JnZVJvY2sgQVMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQKICoKICogVXNlIG9mIHRoaXMgY29kZSByZXF1aXJlcyBhIGNvbW1lcmNpYWwgc29mdHdhcmUgbGljZW5zZSB3aXRoIEZvcmdlUm9jayBBUy4KICogb3Igd2l0aCBvbmUgb2YgaXRzIGFmZmlsaWF0ZXMuIEFsbCB1c2Ugc2hhbGwgYmUgZXhjbHVzaXZlbHkgc3ViamVjdAogKiB0byBzdWNoIGxpY2Vuc2UgYmV0d2VlbiB0aGUgbGljZW5zZWUgYW5kIEZvcmdlUm9jayBBUy4KICovCmltcG9ydCBjb20uaXBsYW5ldC5zc28uU1NPRXhjZXB0aW9uCmltcG9ydCBjb20uc3VuLmlkZW50aXR5LmlkbS5JZFJlcG9FeGNlcHRpb24KaW1wb3J0IGNvbS5zdW4uaWRlbnRpdHkuaWRtLklkVHlwZQppbXBvcnQgb3JnLmZvcmdlcm9jay5vYXV0aDIuY29yZS5Vc2VySW5mb0NsYWltcwoKLyoKKiBEZWZpbmVkIHZhcmlhYmxlczoKKiBsb2dnZXIgLSBhbHdheXMgcHJlc2VudHMsIHRoZSAiT0F1dGgyUHJvdmlkZXIiIGRlYnVnIGxvZ2dlciBpbnN0YW5jZQoqIGNsYWltcyAtIGFsd2F5cyBwcmVzZW50LCBkZWZhdWx0IHNlcnZlciBwcm92aWRlZCBjbGFpbXMKKiBzZXNzaW9uIC0gcHJlc2VudCBpZiB0aGUgcmVxdWVzdCBjb250YWlucyB0aGUgc2Vzc2lvbiBjb29raWUsIHRoZSB1c2VyJ3Mgc2Vzc2lvbiBvYmplY3QKKiBpZGVudGl0eSAtIGFsd2F5cyBwcmVzZW50LCB0aGUgaWRlbnRpdHkgb2YgdGhlIHJlc291cmNlIG93bmVyCiogc2NvcGVzIC0gYWx3YXlzIHByZXNlbnQsIHRoZSByZXF1ZXN0ZWQgc2NvcGVzCiogcmVxdWVzdGVkQ2xhaW1zIC0gTWFwPFN0cmluZywgU2V0PFN0cmluZz4+CiogICAgICAgICAgICAgICAgICBhbHdheXMgcHJlc2VudCwgbm90IGVtcHR5IGlmIHRoZSByZXF1ZXN0IGNvbnRhaW5zIGEgY2xhaW1zIHBhcmFtZXRlciBhbmQgc2VydmVyIGhhcyBlbmFibGVkCiogICAgICAgICAgICAgICAgICBjbGFpbXNfcGFyYW1ldGVyX3N1cHBvcnRlZCwgbWFwIG9mIHJlcXVlc3RlZCBjbGFpbXMgdG8gcG9zc2libGUgdmFsdWVzLCBvdGhlcndpc2UgZW1wdHksCiogICAgICAgICAgICAgICAgICByZXF1ZXN0ZWQgY2xhaW1zIHdpdGggbm8gcmVxdWVzdGVkIHZhbHVlcyB3aWxsIGhhdmUgYSBrZXkgYnV0IG5vIHZhbHVlIGluIHRoZSBtYXAuIEEga2V5IHdpdGgKKiAgICAgICAgICAgICAgICAgIGEgc2luZ2xlIHZhbHVlIGluIGl0cyBTZXQgaW5kaWNhdGVzIHRoaXMgaXMgdGhlIG9ubHkgdmFsdWUgdGhhdCBzaG91bGQgYmUgcmV0dXJuZWQuCiogUmVxdWlyZWQgdG8gcmV0dXJuIGEgTWFwIG9mIGNsYWltcyB0byBiZSBhZGRlZCB0byB0aGUgaWRfdG9rZW4gY2xhaW1zCioKKiBFeHBlY3RlZCByZXR1cm4gdmFsdWUgc3RydWN0dXJlOgoqIFVzZXJJbmZvQ2xhaW1zIHsKKiAgICBNYXA8U3RyaW5nLCBPYmplY3Q+IHZhbHVlczsgLy8gVGhlIHZhbHVlcyBvZiB0aGUgY2xhaW1zIGZvciB0aGUgdXNlciBpbmZvcm1hdGlvbgoqICAgIE1hcDxTdHJpbmcsIExpc3Q8U3RyaW5nPj4gY29tcG9zaXRlU2NvcGVzOyAvLyBNYXBwaW5nIG9mIHNjb3BlIG5hbWUgdG8gYSBsaXN0IG9mIGNsYWltIG5hbWVzLgoqIH0KKi8KCi8vIHVzZXIgc2Vzc2lvbiBub3QgZ3VhcmFudGVlZCB0byBiZSBwcmVzZW50CmJvb2xlYW4gc2Vzc2lvblByZXNlbnQgPSBzZXNzaW9uICE9IG51bGwKCmRlZiBmcm9tU2V0ID0geyBjbGFpbSwgYXR0ciAtPgogICAgaWYgKGF0dHIgIT0gbnVsbCAmJiBhdHRyLnNpemUoKSA9PSAxKXsKICAgICAgICBhdHRyLml0ZXJhdG9yKCkubmV4dCgpCiAgICB9IGVsc2UgaWYgKGF0dHIgIT0gbnVsbCAmJiBhdHRyLnNpemUoKSA+IDEpewogICAgICAgIGF0dHIKICAgIH0gZWxzZSBpZiAobG9nZ2VyLndhcm5pbmdFbmFibGVkKCkpIHsKICAgICAgICBsb2dnZXIud2FybmluZygiT3BlbkFNU2NvcGVWYWxpZGF0b3IuZ2V0VXNlckluZm8oKTogR290IGFuIGVtcHR5IHJlc3VsdCBmb3IgY2xhaW09JGNsYWltIik7CiAgICB9Cn0KCmF0dHJpYnV0ZVJldHJpZXZlciA9IHsgYXR0cmlidXRlLCBjbGFpbSwgaWRlbnRpdHksIHJlcXVlc3RlZCAtPgogICAgaWYgKHJlcXVlc3RlZCA9PSBudWxsIHx8IHJlcXVlc3RlZC5pc0VtcHR5KCkpIHsKICAgICAgICBmcm9tU2V0KGNsYWltLCBpZGVudGl0eS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlKSkKICAgIH0gZWxzZSBpZiAocmVxdWVzdGVkLnNpemUoKSA9PSAxKSB7CiAgICAgICAgcmVxdWVzdGVkLml0ZXJhdG9yKCkubmV4dCgpCiAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBSdW50aW1lRXhjZXB0aW9uKCJObyBzZWxlY3Rpb24gbG9naWMgZm9yICRjbGFpbSBkZWZpbmVkLiBWYWx1ZXM6ICRyZXF1ZXN0ZWQiKQogICAgfQp9CgovLyBbIHtjbGFpbX06IHthdHRyaWJ1dGUgcmV0cmlldmVyfSwgLi4uIF0KY2xhaW1BdHRyaWJ1dGVzID0gWwogICAgICAgICJlbWFpbCI6IGF0dHJpYnV0ZVJldHJpZXZlci5jdXJyeSgibWFpbCIpLAogICAgICAgICJhZGRyZXNzIjogeyBjbGFpbSwgaWRlbnRpdHksIHJlcXVlc3RlZCAtPiBbICJmb3JtYXR0ZWQiIDogYXR0cmlidXRlUmV0cmlldmVyKCJwb3N0YWxhZGRyZXNzIiwgY2xhaW0sIGlkZW50aXR5LCByZXF1ZXN0ZWQpIF0gfSwKICAgICAgICAicGhvbmVfbnVtYmVyIjogYXR0cmlidXRlUmV0cmlldmVyLmN1cnJ5KCJ0ZWxlcGhvbmVudW1iZXIiKSwKICAgICAgICAiZ2l2ZW5fbmFtZSI6IGF0dHJpYnV0ZVJldHJpZXZlci5jdXJyeSgiZ2l2ZW5uYW1lIiksCiAgICAgICAgInpvbmVpbmZvIjogYXR0cmlidXRlUmV0cmlldmVyLmN1cnJ5KCJwcmVmZXJyZWR0aW1lem9uZSIpLAogICAgICAgICJmYW1pbHlfbmFtZSI6IGF0dHJpYnV0ZVJldHJpZXZlci5jdXJyeSgic24iKSwKICAgICAgICAibG9jYWxlIjogYXR0cmlidXRlUmV0cmlldmVyLmN1cnJ5KCJwcmVmZXJyZWRsb2NhbGUiKSwKICAgICAgICAibmFtZSI6IGF0dHJpYnV0ZVJldHJpZXZlci5jdXJyeSgiY24iKSwKICAgICAgICAicm9sZXMiOiB7IGNsYWltLCBpZGVudGl0eSwgcmVxdWVzdGVkIC0+CiAgICAgICAgICAgIGlkZW50aXR5LmdldE1lbWJlcnNoaXBzKElkVHlwZS5HUk9VUCkuY29sbGVjdCB7IGdyb3VwIC0+IGdyb3VwLm5hbWUgfQogICAgICAgIH0gCl0KCi8vIHtzY29wZX06IFsge2NsYWltfSwgLi4uIF0Kc2NvcGVDbGFpbXNNYXAgPSBbCiAgICAgICAgImVtYWlsIjogWyAiZW1haWwiIF0sCiAgICAgICAgImFkZHJlc3MiOiBbICJhZGRyZXNzIiBdLAogICAgICAgICJwaG9uZSI6IFsgInBob25lX251bWJlciIgXSwKICAgICAgICAicHJvZmlsZSI6IFsgImdpdmVuX25hbWUiLCAiem9uZWluZm8iLCAiZmFtaWx5X25hbWUiLCAibG9jYWxlIiwgIm5hbWUiIF0sCiAgICAgICAgInJvbGVzIjogWyAicm9sZXMiIF0KXQoKaWYgKGxvZ2dlci5tZXNzYWdlRW5hYmxlZCgpKSB7CiAgICBzY29wZXMuZmluZEFsbCB7IHMgLT4gISgib3BlbmlkIi5lcXVhbHMocykgfHwgc2NvcGVDbGFpbXNNYXAuY29udGFpbnNLZXkocykpIH0uZWFjaCB7IHMgLT4KICAgICAgICBsb2dnZXIubWVzc2FnZSgiT3BlbkFNU2NvcGVWYWxpZGF0b3IuZ2V0VXNlckluZm8oKTo6TWVzc2FnZTogc2NvcGUgbm90IGJvdW5kIHRvIGNsYWltczogJHMiKQogICAgfQp9CgpkZWYgY29tcHV0ZUNsYWltID0geyBjbGFpbSwgcmVxdWVzdGVkVmFsdWVzIC0+CiAgICB0cnkgewogICAgICAgIFsgY2xhaW0sIGNsYWltQXR0cmlidXRlcy5nZXQoY2xhaW0pKGNsYWltLCBpZGVudGl0eSwgcmVxdWVzdGVkVmFsdWVzKSBdCiAgICB9IGNhdGNoIChJZFJlcG9FeGNlcHRpb24gZSkgewogICAgICAgIGlmIChsb2dnZXIud2FybmluZ0VuYWJsZWQoKSkgewogICAgICAgICAgICBsb2dnZXIud2FybmluZygiT3BlbkFNU2NvcGVWYWxpZGF0b3IuZ2V0VXNlckluZm8oKTogVW5hYmxlIHRvIHJldHJpZXZlIGF0dHJpYnV0ZT0kYXR0cmlidXRlIiwgZSk7CiAgICAgICAgfQogICAgfSBjYXRjaCAoU1NPRXhjZXB0aW9uIGUpIHsKICAgICAgICBpZiAobG9nZ2VyLndhcm5pbmdFbmFibGVkKCkpIHsKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIk9wZW5BTVNjb3BlVmFsaWRhdG9yLmdldFVzZXJJbmZvKCk6IFVuYWJsZSB0byByZXRyaWV2ZSBhdHRyaWJ1dGU9JGF0dHJpYnV0ZSIsIGUpOwogICAgICAgIH0KICAgIH0KfQoKZGVmIGNvbXB1dGVkQ2xhaW1zID0gc2NvcGVzLmZpbmRBbGwgeyBzIC0+ICEib3BlbmlkIi5lcXVhbHMocykgJiYgc2NvcGVDbGFpbXNNYXAuY29udGFpbnNLZXkocykgfS5pbmplY3QoY2xhaW1zKSB7IG1hcCwgcyAtPgogICAgc2NvcGVDbGFpbXMgPSBzY29wZUNsYWltc01hcC5nZXQocykKICAgIG1hcCA8PCBzY29wZUNsYWltcy5maW5kQWxsIHsgYyAtPiAhcmVxdWVzdGVkQ2xhaW1zLmNvbnRhaW5zS2V5KGMpIH0uY29sbGVjdEVudHJpZXMoWzpdKSB7IGNsYWltIC0+IGNvbXB1dGVDbGFpbShjbGFpbSwgbnVsbCkgfQp9LmZpbmRBbGwgeyBtYXAgLT4gbWFwLnZhbHVlICE9IG51bGwgfSA8PCByZXF1ZXN0ZWRDbGFpbXMuY29sbGVjdEVudHJpZXMoWzpdKSB7IGNsYWltLCByZXF1ZXN0ZWRWYWx1ZSAtPgogICAgY29tcHV0ZUNsYWltKGNsYWltLCByZXF1ZXN0ZWRWYWx1ZSkKfQoKZGVmIGNvbXBvc2l0ZVNjb3BlcyA9IHNjb3BlQ2xhaW1zTWFwLmZpbmRBbGwgeyBzY29wZSAtPgogICAgc2NvcGVzLmNvbnRhaW5zKHNjb3BlLmtleSkKfQoKcmV0dXJuIG5ldyBVc2VySW5mb0NsYWltcygoTWFwKWNvbXB1dGVkQ2xhaW1zLCAoTWFwKWNvbXBvc2l0ZVNjb3Blcyk=",
    "_type" : {
      "_id" : "globalScript",
      "name" : "Scripting",
      "collection" : true
    }
  }
}